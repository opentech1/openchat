"use client"

import * as React from "react"
import { Check, ChevronDown, Sparkles } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import {
	ModelSelector as AIModelSelector,
	ModelSelectorTrigger,
	ModelSelectorContent,
	ModelSelectorInput,
	ModelSelectorList,
	ModelSelectorEmpty,
	ModelSelectorGroup,
	ModelSelectorItem,
	ModelSelectorName,
	ModelSelectorLogo,
	ModelSelectorLogoGroup,
} from "@/components/ai-elements/model-selector"
import { registerClientProperties } from "@/lib/posthog"
import { borderRadius, shadows, spacing } from "@/styles/design-tokens"

export type ModelSelectorOption = {
	value: string
	label: string
	description?: string
	context?: number | null
	pricing?: {
		prompt: number | null
		completion: number | null
	}
	icon?: React.ComponentType<React.SVGProps<SVGSVGElement>>
}

type ModelSelectorProps = {
	options: ModelSelectorOption[]
	value?: string | null
	onChange?: (value: string) => void
	disabled?: boolean
	loading?: boolean
}

const TOKENS_PER_MILLION = 1_000_000

// Memoize the number formatters to avoid recreating them on every render
const getNumberFormatter = (() => {
	const cache = new Map<number, Intl.NumberFormat>();
	return (fractionDigits: number): Intl.NumberFormat => {
		if (!cache.has(fractionDigits)) {
			cache.set(
				fractionDigits,
				new Intl.NumberFormat("en-US", {
					style: "currency",
					currency: "USD",
					minimumFractionDigits: fractionDigits,
					maximumFractionDigits: fractionDigits,
				})
			);
		}
		return cache.get(fractionDigits)!;
	};
})();

function formatCost(cost: number | null) {
	if (cost == null || !Number.isFinite(cost)) return "–"
	const abs = Math.abs(cost)
	let fractionDigits = 3
	if (abs >= 1) fractionDigits = 2
	else if (abs >= 0.1) fractionDigits = 3
	else if (abs >= 0.01) fractionDigits = 4
	else if (abs >= 0.001) fractionDigits = 5
	else fractionDigits = 6
	return getNumberFormatter(fractionDigits).format(cost)
}

const scaleCostToMillion = (cost: number | null) => {
	if (cost == null || !Number.isFinite(cost)) return null
	return cost * TOKENS_PER_MILLION
}

function formatPricing(pricing: NonNullable<ModelSelectorOption["pricing"]>) {
	const promptPerMillion = scaleCostToMillion(pricing.prompt)
	const completionPerMillion = scaleCostToMillion(pricing.completion)
	return `In: ${formatCost(promptPerMillion)} · Out: ${formatCost(completionPerMillion)} per 1M tokens`
}

const getInitial = (label: string) => {
	const trimmed = label.trim()
	return trimmed.length > 0 ? trimmed[0]!.toUpperCase() : "?"
}

// Extract provider from model ID (e.g. "openai/gpt-4" -> "openai")
function getProviderFromModelId(modelId: string): string | null {
	const parts = modelId.split("/")
	return parts.length > 1 ? parts[0]! : null
}

function OptionGlyph({ option }: { option: ModelSelectorOption | null }) {
	if (!option) {
		return <Sparkles className="size-4" />
	}
	const Icon = option.icon
	if (Icon) {
		return <Icon className="size-4" />
	}

	// Try to show provider logo if available
	const provider = getProviderFromModelId(option.value)
	if (provider) {
		return (
			<ModelSelectorLogoGroup>
				<ModelSelectorLogo provider={provider} />
			</ModelSelectorLogoGroup>
		)
	}

	return (
		<span className="text-foreground/80 text-[11px] font-semibold uppercase leading-none">
			{getInitial(option.label)}
		</span>
	)
}

function ModelSelector({ options, value, onChange, disabled, loading }: ModelSelectorProps) {
	const [open, setOpen] = React.useState(false)
	const [internalValue, setInternalValue] = React.useState(() => value ?? options[0]?.value ?? "")

	React.useEffect(() => {
		if (value !== undefined) {
			setInternalValue(value ?? "")
		}
	}, [value])

	React.useEffect(() => {
		if (value !== undefined) return
		if (options.length === 0) {
			if (internalValue) setInternalValue("")
			return
		}
		const exists = internalValue && options.some((option) => option.value === internalValue)
		if (!internalValue || !exists) {
			setInternalValue(options[0]!.value)
		}
	}, [options, value, internalValue])

	const selectedValue = value ?? internalValue
	const selectedOption = React.useMemo(() => {
		return options.find((option) => option.value === selectedValue) ?? null
	}, [options, selectedValue])

	React.useEffect(() => {
		if (!selectedValue) return
		registerClientProperties({ model_id: selectedValue })
	}, [selectedValue])

	const triggerLabel = React.useMemo(() => {
		if (selectedOption) return selectedOption.label
		if (loading) return "Loading models..."
		return "Select model"
	}, [loading, selectedOption])

	const triggerTitle = React.useMemo(() => {
		if (!selectedOption) return undefined
		const parts: string[] = []
		if (selectedOption.context) parts.push(`Context: ${Intl.NumberFormat().format(selectedOption.context)} tokens`)
		if (selectedOption.pricing) parts.push(formatPricing(selectedOption.pricing))
		return parts.length > 0 ? parts.join(" • ") : undefined
	}, [selectedOption])

	return (
		<AIModelSelector open={open} onOpenChange={setOpen}>
			<ModelSelectorTrigger asChild>
				<Button
					variant="outline"
					size="sm"
					disabled={disabled || loading || options.length === 0}
					role="combobox"
					aria-expanded={open}
					aria-haspopup="listbox"
					aria-label={`Select AI model. Current selection: ${triggerLabel}`}
					title={triggerTitle}
					className={cn("flex h-10 min-w-[220px] max-w-[360px] items-center justify-between bg-background/90 px-3 text-left text-foreground", borderRadius.lg, spacing.gap.sm)}
				>
					<span className={cn("flex min-w-0 items-center", spacing.gap.sm)}>
						<span className={cn("bg-muted text-muted-foreground/90 flex size-8 items-center justify-center", borderRadius.md)}>
							<OptionGlyph option={selectedOption} />
						</span>
						<span className="truncate text-sm font-medium leading-tight text-left">{triggerLabel}</span>
					</span>
					<ChevronDown className={cn("size-4 transition-transform", open ? "rotate-180" : "rotate-0", disabled ? "opacity-40" : "opacity-60")} />
				</Button>
			</ModelSelectorTrigger>
			<ModelSelectorContent title="Select AI Model" className={cn("w-[320px] max-w-[90vw]", shadows.xl)}>
				<ModelSelectorInput
					placeholder="Search models"
					aria-label="Search AI models"
				/>
				<ModelSelectorList className="max-h-60" role="listbox">
					<ModelSelectorEmpty className="py-6 text-sm text-muted-foreground" role="status">
						{loading ? "Loading models..." : "No models found."}
					</ModelSelectorEmpty>
					<ModelSelectorGroup className={cn("flex flex-col p-2", spacing.gap.xs)} aria-label="Available models">
						{options.map((option) => {
							const isSelected = option.value === selectedValue
							return (
								<ModelSelectorItem
									key={option.value}
									value={option.value}
									onSelect={(currentValue) => {
										if (value === undefined) {
											setInternalValue(currentValue)
										}
										onChange?.(currentValue)
										setOpen(false)
									}}
									role="option"
									aria-selected={isSelected}
									aria-label={option.label}
									className={cn(
										"flex items-center justify-between px-3 py-2",
										borderRadius.md,
										spacing.gap.sm,
										"data-[selected=true]:bg-primary/10 data-[selected=true]:text-foreground",
									)}
								>
									<span className={cn("flex min-w-0 items-start", spacing.gap.sm)}>
										<span className={cn("bg-muted text-muted-foreground flex size-7 items-center justify-center", borderRadius.md)}>
											<OptionGlyph option={option} />
										</span>
										<span className="flex min-w-0 flex-col gap-0.5">
											<ModelSelectorName className="text-sm font-medium leading-tight text-left whitespace-normal">
												{option.label}
											</ModelSelectorName>
											{option.pricing ? (
												<span className="text-muted-foreground text-[11px] leading-tight">
													{formatPricing(option.pricing)}
												</span>
											) : null}
											{option.context ? (
												<span className="text-muted-foreground text-[11px] leading-tight">
													Context: {Intl.NumberFormat().format(option.context)} tokens
												</span>
											) : null}
										</span>
									</span>
									<Check className={cn("size-4", isSelected ? "opacity-100" : "opacity-0")}
										aria-hidden={!isSelected}
									/>
								</ModelSelectorItem>
							)
						})}
					</ModelSelectorGroup>
				</ModelSelectorList>
			</ModelSelectorContent>
		</AIModelSelector>
	)
}

ModelSelector.displayName = "ModelSelector";

export const MemoizedModelSelector = React.memo(ModelSelector);
export { MemoizedModelSelector as ModelSelector };
