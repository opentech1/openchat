# Convex functions

OpenChat's `apps/server/convex` workspace replaces the former Elysia server. It contains the Convex schema, queries, and mutations that back the chat UI.

## Directory tour
- `schema.ts` – defines `users`, `chats`, and `messages` tables plus the supporting indexes that power lookups by owner and client message ids.
- `users.ts` – ensures there is a Convex document for every WorkOS session and keeps profile fields in sync.
- `chats.ts` – CRUD helpers for chat rows, including safeguards that keep delete operations scoped to the current user.
- `messages.ts` – batched writes for user/assistant pairs and the streaming upsert mutation that the chat transport uses to persist incremental responses.
- `http.ts` – a lightweight health check that Docker and uptime checks can hit.
- `_generated/*` – auto generated by the Convex CLI; never edit by hand.
- `tsconfig.json` – local type configuration used by `bun check-types` and IDE tooling.

## Runtime expectations
- Mutations that return ids always coerce to Convex ids so callers can safely reuse them across the monorepo.
- The streaming upsert mutation is idempotent; it deduplicates by `messageId` or `clientMessageId` so replays from the API transport do not create duplicate rows.
- Query helpers enforce ownership before returning data. Keep new document types following the same `assertOwns*` pattern.

## Local development
`bun dev` from the repo root automatically starts `convex dev` in this directory. To add new functions:
1. Create the query or mutation using the "new syntax" outlined in `convex-rules.txt`.
2. Update `schema.ts` if new tables or indexes are needed.
3. Run `bun check-types` to ensure the generated API surface compiles.

## Deploying
- Production deployments are driven by `convex.json`. Update its deployment name when creating a new environment.
- Whenever you change `schema.ts`, run `bun x convex codegen` so that the generated API typings stay in sync for the Next.js app.
- The Docker and Dokploy guides rely on the `/health` endpoint exposed in `http.ts`. Keep it lightweight and unauthenticated.

For deeper guidance see `convex-rules.txt` in the repo root.
